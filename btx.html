<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Theo Dõi Dữ Liệu BTX</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family:Arial,Helvetica,sans-serif; margin:20px; background:#f7f7f7;}
    h2{text-align:center}
    .card {background:white; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.08); padding:16px; margin-bottom:16px;}
    .grid {display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:12px;}
    .info-box {padding:12px; text-align:center; border-radius:6px; background:#fff; border:1px solid #eee;}
    .info-box h3 {margin:8px 0 4px; font-size:18px;}
    .info-box p {margin:0; font-size:14px; color:#555;}
    #canvasWrap {height:360px;}
  </style>
</head>
<body>
  <h2>Theo Dõi Dữ Liệu BTX</h2>

  <div class="card" id="chartCard">
    <div id="canvasWrap">
      <canvas id="hashChart"></canvas>
    </div>
  </div>

  <div class="card">
    <div class="grid">
      <div class="info-box">
        <h3 id="val_temp">--</h3>
        <p>Nhiệt độ Chip</p>
      </div>
      <div class="info-box">
        <h3 id="val_vrtemp">--</h3>
        <p>Nhiệt Độ IC Điện Áp</p>
      </div>
      <div class="info-box">
        <h3 id="val_freq">--</h3>
        <p>Tần Số CPU</p>
      </div>
      <div class="info-box">
        <h3 id="val_volt">--</h3>
        <p>Điện Áp CPU</p>
      </div>
    </div>
  </div>

<script>
  const CHANNEL_ID = '3187244';
  const READ_API_KEY = 'V9AVUWJB5I9K32D4';

  // Số point lấy về
  const RESULTS = 100;

  function buildApiUrl() {
    let url = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?results=${RESULTS}`;
    if (READ_API_KEY && READ_API_KEY.length > 0) {
      url += `&api_key=${READ_API_KEY}`;
    }
    return url;
  }

  async function fetchData() {
    const url = buildApiUrl();
    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const j = await res.json();
      return j;
    } catch (e) {
      console.error('Fetch error', e);
      return null;
    }
  }

  function parseAndPlot(data) {
    if (!data || !data.feeds) return;
    const feeds = data.feeds;

    const labels = [];
    const hrData = [];

    let lastTemp = '--', lastVr = '--', lastFreq = '--', lastVolt = '--';

    for (let i = 0; i < feeds.length; i++) {
      const f = feeds[i];

      let t = f.created_at ? new Date(f.created_at) : new Date();
      labels.push(t.toLocaleTimeString());
      let v1 = parseFloat(f.field1);
      hrData.push(isNaN(v1) ? null : v1);

      if (f.field2 && f.field2 !== '') lastTemp = f.field2;
      if (f.field3 && f.field3 !== '') lastVr = f.field3;
      if (f.field4 && f.field4 !== '') lastFreq = f.field4;
      if (f.field5 && f.field5 !== '') lastVolt = f.field5;
    }

    document.getElementById('val_temp').innerText = lastTemp;
    document.getElementById('val_vrtemp').innerText = lastVr;
    document.getElementById('val_freq').innerText = lastFreq;
    document.getElementById('val_volt').innerText = lastVolt;

    if (window.hashChartInstance) {
      window.hashChartInstance.data.labels = labels;
      window.hashChartInstance.data.datasets[0].data = hrData;
      window.hashChartInstance.update();
    } else {
      const ctx = document.getElementById('hashChart').getContext('2d');
      window.hashChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Hashrate',
            data: hrData,
            fill: true,
            tension: 0.2,
            pointRadius: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              display: true,
              title: { display: true, text: 'Time' }
            },
            y: {
              display: true,
              title: { display: true, text: 'Hashrate' },
              beginAtZero: true
            }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    }
  }

  async function refreshLoop() {
    const data = await fetchData();
    parseAndPlot(data);
  }

  refreshLoop();
  setInterval(refreshLoop, 15000);
</script>
</body>
</html>
