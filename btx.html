<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Theo Dõi BTX — 3 ThingSpeak Channels</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family:Arial,Helvetica,sans-serif; margin:16px; background:#f7f7f7;}
    .wrap{max-width:1100px;margin:12px auto;}
    h2{text-align:center;margin:6px 0 10px;}
    .controls {text-align:center; margin-bottom:12px;}
    .btn {background:#2d9cdb;color:#fff;border:none;padding:8px 12px;border-radius:6px;margin:0 6px;cursor:pointer;}
    .btn.active {background:#1b6f9a;}
    .card {background:white; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.08); padding:16px; margin-bottom:16px;}
    #canvasWrap {height:360px;}
    table.ts-info, table.minmax-table {
      width:100%; border-collapse:collapse; margin-top:12px;
    }
    table.ts-info th, table.ts-info td,
    table.minmax-table th, table.minmax-table td {
      border:1px solid #eee; padding:8px; text-align:center; font-size:14px;
    }
    table.ts-info th, table.minmax-table th {
      background:#fafafa; font-weight:600;
    }
    .warn { font-size:12px;color:#b44; margin-top:8px; text-align:center; }
    @media (max-width:640px) {
      #canvasWrap {height:240px;}
      .btn{padding:6px 8px; margin:4px;}
      td{font-size:12px;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Theo Dõi Dữ Liệu BTX</h2>

    <div class="controls card">
      <span>Thời gian hiển thị: </span>
      <button class="btn" data-mins="10">10 phút</button>
      <button class="btn" data-mins="30">30 phút</button>
      <button class="btn" data-mins="60">1 giờ</button>
      <button class="btn" data-mins="180">3 giờ</button>
      <button class="btn" data-mins="360">6 giờ</button>
      <div style="margin-top:8px;color:#666;font-size:13px;"></div>
    </div>

    <div class="card" id="chartCard">
      <div id="canvasWrap"><canvas id="hashChart"></canvas></div>
    </div>

    <!-- Latest data table -->
    <div class="card">
      <h3 style="margin:0 0 8px 0">Dữ liệu hiện tại</h3>
      <table class="ts-info">
        <thead>
          <tr>
            <th>Hashrate</th>
            <th>Temp (°C)</th>
            <th>VR Temp (°C)</th>
            <th>Freq (MHz)</th>
            <th>Volt (V)</th>
          </tr>
        </thead>
        <tbody>
          <tr><td id="k1_hr">--</td><td id="k1_temp">--</td><td id="k1_vr">--</td><td id="k1_freq">--</td><td id="k1_volt">--</td></tr>
          <tr><td id="k2_hr">--</td><td id="k2_temp">--</td><td id="k2_vr">--</td><td id="k2_freq">--</td><td id="k2_volt">--</td></tr>
          <tr><td id="k3_hr">--</td><td id="k3_temp">--</td><td id="k3_vr">--</td><td id="k3_freq">--</td><td id="k3_volt">--</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Per-channel min/max -->
    <div class="card">
      <h3 style="margin:0 0 8px 0">Min/Max từng máy</h3>
      <table class="minmax-table">
        <thead>
          <tr>
            <th>30 phút</th>
            <th>1 giờ</th>
            <th>6 giờ</th>
            <th>12 giờ</th>
            <th>24 giờ</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td id="m_k1_30m">-- / --</td>
            <td id="m_k1_1h">-- / --</td>
            <td id="m_k1_6h">-- / --</td>
            <td id="m_k1_12h">-- / --</td>
            <td id="m_k1_24h">-- / --</td>
          </tr>
          <tr>
            <td id="m_k2_30m">-- / --</td>
            <td id="m_k2_1h">-- / --</td>
            <td id="m_k2_6h">-- / --</td>
            <td id="m_k2_12h">-- / --</td>
            <td id="m_k2_24h">-- / --</td>
          </tr>
          <tr>
            <td id="m_k3_30m">-- / --</td>
            <td id="m_k3_1h">-- / --</td>
            <td id="m_k3_6h">-- / --</td>
            <td id="m_k3_12h">-- / --</td>
            <td id="m_k3_24h">-- / --</td>
          </tr>
        </tbody>
      </table>
      <div class="warn" id="minmaxWarn" style="display:none;">⚠️ Giới hạn 8000 điểm — Min/Max có thể thiếu dữ liệu.</div>
    </div>

  </div>

<script>
/* ==== Channel list ==== */
const CHANNELS = [
  { id: 3187244, key: 'V9AVUWJB5I9K32D4' },
  { id: 3192699, key: '3IUSF5ID0VGIULVA' },
  { id: 3192701, key: 'DSKEV3IZ5UVHVMP5' }
];

const COLORS = ['#1f77b4', '#ff7f0e', '#2ca02c'];
let MINUTES = 10;
const RESULTS = 8000;
let chart = null;

/* Helper: format timestamp */
function tsFmt(d){
  return `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}-${String(d.getUTCDate()).padStart(2,'0')}%20${String(d.getUTCHours()).padStart(2,'0')}:${String(d.getUTCMinutes()).padStart(2,'0')}:${String(d.getUTCSeconds()).padStart(2,'0')}`;
}
function urlForChannel(ch, mins){
  let d = new Date(Date.now() - mins*60000);
  return `https://api.thingspeak.com/channels/${ch.id}/feeds.json?api_key=${ch.key}&start=${tsFmt(d)}&results=${RESULTS}`;
}
async function fetchJson(url){
  try{
    let r = await fetch(url);
    if(!r.ok) throw 0;
    return await r.json();
  }catch(e){ return null; }
}

/* Parse */
function parseFeeds(j){
  if(!j||!j.feeds) return {pts:[], meta:{}};
  let pts=[], last={};
  for(const f of j.feeds){
    pts.push({t:new Date(f.created_at), v:Number(f.field1)||null});
    if(f.field1) last.hr=f.field1;
    if(f.field2) last.temp=f.field2;
    if(f.field3) last.vr=f.field3;
    if(f.field4) last.freq=f.field4;
    if(f.field5) last.volt=f.field5;
  }
  pts.sort((a,b)=>a.t-b.t);
  return {pts, meta:last};
}

/* Align for chart */
function alignSeries(all){
  let times=new Set();
  all.forEach(ch=>ch.forEach(p=>times.add(p.t.getTime())));
  times=[...times].sort((a,b)=>a-b);
  let labels=times.map(ms=>new Date(ms).toLocaleTimeString());
  let datasets=all.map((arr,i)=>{
    let map=new Map(arr.map(p=>[p.t.getTime(),p.v]));
    return {
      label:`Ch ${i+1}`,
      data:times.map(ms=>map.get(ms)??null),
      color:COLORS[i]
    };
  });
  return {labels,datasets};
}

/* Render chart */
function renderChart(lbl, ds){
  if(!chart){
    chart=new Chart(hashChart.getContext("2d"),{
      type:"line",
      data:{labels:lbl, datasets:ds.map(x=>({
        label:x.label, data:x.data,
        borderColor:x.color, backgroundColor:x.color,
        tension:0.2, pointRadius:2, fill:false, spanGaps:true
      }))},
      options:{
        responsive:true, maintainAspectRatio:false,
        scales:{y:{beginAtZero:true}}
      }
    });
  }else{
    chart.data.labels=lbl;
    chart.data.datasets=ds.map(x=>({
      label:x.label, data:x.data,
      borderColor:x.color, backgroundColor:x.color,
      tension:0.2, pointRadius:2, fill:false, spanGaps:true
    }));
    chart.update();
  }
}

/* Update latest info */
function updateLatest(meta,i){
  let idx=i+1;
  let m=meta||{};
  document.getElementById(`k${idx}_hr`).innerText   = m.hr   ? Number(m.hr).toFixed(1)   : "--";
  document.getElementById(`k${idx}_temp`).innerText = m.temp ? Number(m.temp).toFixed(1) : "--";
  document.getElementById(`k${idx}_vr`).innerText   = m.vr   ? Number(m.vr).toFixed(1)   : "--";
  document.getElementById(`k${idx}_freq`).innerText = m.freq ? Math.round(m.freq)        : "--";
  let v="--";
  if(m.volt){
    let nv=Number(m.volt);
    v = isFinite(nv) ? (nv>50? (nv/1000).toFixed(2) : nv.toFixed(3)) : "--";
  }
  document.getElementById(`k${idx}_volt`).innerText = v;
}

/* Min / max per channel */
function minmax(feeds){
  let min=NaN,max=NaN;
  feeds.forEach(f=>{
    let n=Number(f.field1);
    if(!isFinite(n)) return;
    if(isNaN(min)||n<min) min=n;
    if(isNaN(max)||n>max) max=n;
  });
  return {min,max};
}

async function updateMinMax(){
  const intervals=[
    {m:30,s:'30m'},
    {m:60,s:'1h'},
    {m:360,s:'6h'},
    {m:720,s:'12h'},
    {m:1440,s:'24h'}
  ];
  minmaxWarn.style.display="none";
  for(let ci=0;ci<CHANNELS.length;ci++){
    for(let it of intervals){
      let j=await fetchJson(urlForChannel(CHANNELS[ci],it.m));
      let id=`m_k${ci+1}_${it.s}`;
      if(!j||!j.feeds){ document.getElementById(id).innerText="-- / --"; continue; }
      let mm=minmax(j.feeds);
      if(isNaN(mm.min)) document.getElementById(id).innerText="-- / --";
      else document.getElementById(id).innerText=`${mm.min.toFixed(1)} / ${mm.max.toFixed(1)}`;
      if(j.feeds.length>=RESULTS) minmaxWarn.style.display="block";
      await new Promise(r=>setTimeout(r,120));
    }
  }
}

/* Main refresh */
async function refreshAll(){
  let reqs=CHANNELS.map(ch=>fetchJson(urlForChannel(ch,MINUTES)));
  let results=await Promise.all(reqs);

  let parsed=results.map(r=>parseFeeds(r));
  let allPoints=parsed.map(x=>x.pts);
  let metas=parsed.map(x=>x.meta);

  let aligned=alignSeries(allPoints);
  renderChart(aligned.labels, aligned.datasets);

  metas.forEach((m,i)=>updateLatest(m,i));

  updateMinMax();
}

/* Init */
document.querySelectorAll('.btn').forEach(b=>{
  b.onclick=()=>{ MINUTES=Number(b.dataset.mins); document.querySelectorAll('.btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); refreshAll(); };
  if(Number(b.dataset.mins)==MINUTES) b.classList.add('active');
});

refreshAll();
setInterval(refreshAll,30000);
</script>
</body>
</html>
