<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Siêu Seeding</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f0f2f5; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        button { padding: 12px 20px; font-size: 15px; cursor: pointer; border: none; border-radius: 6px; transition: 0.2s; font-weight: bold; }
        .btn-primary { background: #1877f2; color: white; }
        .btn-secondary { background: #42b72a; color: white; }
        .btn-primary:hover { background: #166fe5; }
        .result-box { background: #fff; border: 1px solid #ddd; padding: 15px; border-radius: 8px; min-height: 80px; font-size: 17px; margin-bottom: 15px; position: relative; }
        .stats-bar { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px; color: #555; }
        .stat-item { background: #e7f3ff; padding: 10px; border-radius: 6px; border: 1px solid #d1e7ff; }
        .highlight { color: #1877f2; font-weight: bold; font-size: 15px; }
        .status { margin-bottom: 10px; font-style: italic; color: #666; font-size: 13px; }
    </style>
</head>
<body>

<div class="card">
    <h2>Super Seeding</h2>
    
    <div class="controls">
        <button class="btn-primary" onclick="processXoay('aff')">Tiếp Thị</button>
        <button class="btn-primary" onclick="processXoay('nuoi')">Tương Tác</button>
        <button class="btn-secondary" onclick="copyToClipboard()">Sao chép</button>
    </div>

    <div id="status" class="status">Chào mừng bạn tới hệ thống nội dung xoay cho facebook...</div>

    <div class="result-box" id="outputText">Để có thể tìm được nội dung trùng nhau khó hơn trúng xổ số</div>

    <div class="stats-bar">
        <div class="stat-item">
            Tổng biến thể của file:<br>
            <span id="totalFileVariations" class="highlight">0</span>
			</div>
        <div class="stat-item">
            Biến thể của khối đã chọn:<br>
            <span id="blockVariations" class="highlight">0</span>
        </div>
    </div>
</div>

<script>
const BASE_URL = "https://raw.githubusercontent.com/npbk21/congtodien/refs/heads/main/";

// === THAY THẾ HÀM countVariations CŨ BẰNG HÀM MỚI NÀY ===

function countVariations(text) {
    if (!text || typeof text !== 'string') return 0;

    // Hàm đệ quy để xử lý các nhóm lồng nhau
    function parseSegment(segment) {
        let total = 1; // Tích số cho đoạn văn bản hiện tại
        let i = 0;
        const len = segment.length;

        while (i < len) {
            const char = segment[i];
            if (char === '{') {
                // Tìm dấu '}' đóng cho nhóm này, chú ý đến độ lồng nhau
                let depth = 1;
                let j = i + 1;
                while (j < len && depth > 0) {
                    if (segment[j] === '{') depth++;
                    if (segment[j] === '}') depth--;
                    j++;
                }
                // j bây giờ là vị trí sau dấu '}' đóng

                // Lấy nội dung bên trong dấu ngoặc nhọn (bao gồm cả các nhóm con)
                const innerContent = segment.substring(i + 1, j - 1);

                // Tách các lựa chọn con bên trong, nhưng phải cẩn thận với các nhóm lồng nhau
                const options = [];
                let optionStart = 0;
                let optionDepth = 0;
                for (let k = 0; k < innerContent.length; k++) {
                    const ch = innerContent[k];
                    if (ch === '{') optionDepth++;
                    if (ch === '}') optionDepth--;
                    if (ch === '|' && optionDepth === 0) {
                        options.push(innerContent.substring(optionStart, k));
                        optionStart = k + 1;
                    }
                }
                options.push(innerContent.substring(optionStart)); // Thêm lựa chọn cuối cùng

                // Tính tổng số biến thể cho nhóm này bằng cách nhân tổng số biến thể của từng lựa chọn con
                let optionTotal = 0;
                for (const opt of options) {
                    // Đệ quy: mỗi lựa chọn con lại có thể chứa nhóm xoay con của nó
                    optionTotal += parseSegment(opt);
                }

                // Nhân vào tổng số của đoạn hiện tại
                total *= optionTotal;

                // Di chuyển chỉ số i lên sau dấu '}' vừa xử lý
                i = j;
            } else {
                // Nếu là ký tự bình thường (không phải '{'), chỉ cần tăng i lên 1
                i++;
            }
        }
        // Trường hợp cơ bản: Nếu đoạn văn bản không chứa '{' nào, parseSegment trả về 1
        // vì nó chỉ là một lựa chọn văn bản thuần túy.
        // Tuy nhiên, nếu toàn bộ segment là rỗng? Trong ngữ cảnh này, một lựa chọn rỗng vẫn được tính là 1 cách.
        // Ví dụ: {|A} có nghĩa là "không có gì" hoặc "A". Đoạn rỗng này vẫn là 1 cách.
        if (total === 1 && segment.includes('{') === false) {
             return 1; // Văn bản thuần túy, không có spin, chỉ là 1 lựa chọn duy nhất.
        }
        return total;
    }

    // Bắt đầu phân tích toàn bộ văn bản
    // Chú ý: Nếu toàn bộ văn bản được bao bởi '{}' thì chúng ta cần xử lý nó như một nhóm.
    // Nhưng trong trường hợp file của bạn, mỗi khối là một câu hỏi hoàn chỉnh và thường không được bao bọc.
    // Hàm parseSegment ở trên đã xử lý bằng cách duyệt qua từng ký tự, nên nó sẽ hoạt động chính xác cho cả hai trường hợp.
    const finalTotal = parseSegment(text);
    return finalTotal;
}

// === GIỮ NGUYÊN PHẦN CÒN LẠI CỦA MÃ NGUỒN ===
// (Các hàm getLargeBlocks, XoayFinal, processXoay, copyToClipboard giữ nguyên)

// Hàm tách các khối lớn cấp 1
function getLargeBlocks(content) {
    // Loại bỏ dấu ngoặc bao ngoài cùng nếu có
    let inner = content.trim();
    if (inner.startsWith('{') && inner.endsWith('}')) {
        inner = inner.substring(1, inner.length - 1);
    }

    const blocks = [];
    let level = 0;
    let current = "";
    for (let char of inner) {
        if (char === '{') level++;
        if (char === '}') level--;
        if (char === '|' && level === 0) {
            blocks.push(current);
            current = "";
        } else {
            current += char;
        }
    }
    blocks.push(current);
    return blocks.filter(b => b.trim() !== "");
}

function XoayFinal(text) {
    const regex = /\{([^{}]*)\}/;
    while (regex.test(text)) {
        text = text.replace(regex, (match, options) => {
            const choices = options.split("|");
            return choices[Math.floor(Math.random() * choices.length)];
        });
    }
    return text;
}

async function processXoay(type) {
    const status = document.getElementById("status");
    const output = document.getElementById("outputText");
    const totalDisplay = document.getElementById("totalFileVariations");
    const blockDisplay = document.getElementById("blockVariations");

    const fileName = type === 'aff' ? 'aff.txt' : 'nuoi.txt';
    status.textContent = `⏳ Đang tải ${fileName}...`;

    try {
        const res = await fetch(BASE_URL + fileName, { cache: "no-store" });
        if (!res.ok) throw new Error("Không thể tải file từ GitHub");
        const content = await res.text();

        // 1. Tách các khối lớn (Khối A, B, C...)
        const blocks = getLargeBlocks(content);

        // 2. Tính tổng biến thể của TOÀN BỘ file (A + B + C + ...)
        let fileTotal = 0;
        blocks.forEach(b => {
            fileTotal += countVariations(b);
        });

        const randomIndex = Math.floor(Math.random() * blocks.length);
        const selectedBlock = blocks[randomIndex];
        const blockTotal = countVariations(selectedBlock);

        const result = XoayFinal(selectedBlock);

        output.textContent = result;
        totalDisplay.textContent = fileTotal.toLocaleString();
        blockDisplay.textContent = blockTotal.toLocaleString();
        status.textContent = `✅ Đã chọn ngẫu nhiên Khối ${randomIndex + 1}/${blocks.length} từ ${fileName}`;

    } catch (err) {
        status.textContent = "❌ Lỗi: " + err.message;
        console.error(err);
    }
}

function copyToClipboard() {
    const text = document.getElementById("outputText").textContent;
    if (text.includes("...")) return;
    navigator.clipboard.writeText(text);
    alert("Đã sao chép nội dung!");
}
</script>

</body>
</html>